# Main technologies of architecture

## Architecture Overview

![IoT Event Streaming Architecture](https://miro.medium.com/v2/resize:fit:2000/format:webp/1*IUaBLlbVKgmsjbjqzew0ZQ.png)

## Eclipse Mosquitto

Eclipse Mosquitto เป็นซอฟต์แวร์โอเพ่นซอร์สที่ทำหน้าที่เป็น MQTT broker ซึ่งเป็นตัวกลางในการสื่อสารผ่านโปรโตคอล MQTT (Message Queuing Telemetry Transport) โดยโปรโตคอลนี้ออกแบบมาให้ส่งข้อความระหว่างอุปกรณ์ที่เชื่อมต่อในเครือข่าย เช่น อุปกรณ์ IoT ที่ต้องการการสื่อสารที่มีประสิทธิภาพและใช้ทรัพยากรน้อย โดย คุณสมบัติหลักของ Eclipse Mosquitto โอเพ่นซอร์ส ซึ่งคือ ทุกคนสามารถดาวน์โหลดและใช้งานได้ฟรี รวมถึงแก้ไขซอฟต์แวร์ได้ รองรับ MQTT ทำหน้าที่เป็นตัวกลางสำหรับการส่งและรับข้อความระหว่างอุปกรณ์ที่ใช้โปรโตคอล MQTT แถมยังติดตั้งง่าย รองรับหลายระบบปฏิบัติการ เช่น Windows, macOS และ Linux เรื่องความปลอดภัย รองรับการเข้ารหัส SSL/TLS และการตรวจสอบสิทธิ์ของผู้ใช้ 

## Apache ZooKeeper

Apache Zookeeper เป็นระบบจัดการและประสานงานแบบกระจาย (distributed coordination service) ที่ช่วยจัดการข้อมูลการกำหนดค่า การตั้งค่าการทำงาน และการติดตามสถานะของระบบในเครือข่ายขนาดใหญ่ โดยถูกใช้บ่อยในระบบที่ต้องการความทนทานและความเสถียรสูง เช่น Apache Kafka, Hadoop และ Hbase โดยมีหน้าที่และคุณสมบัติดังนี้
- ทำหน้าที่จัดการ brokers คือรู้ว่า broker ตัวไหน อยู่ที่ไหน ตายอยู่หรือไม่ตาย
- บันทึกว่า topic ไหนมีหรือไม่มี มีกี่ partition ใน topic นี้
- ทำการเลือก leader/replica ของ partition
- ส่งสัญญาณไปหา Kafka ในทุกๆ การเปลี่ยนแปลงที่เกิดขึ้น เช่น มี topic มาใหม่ หรือมี broker ตาย หรือเพิ่มขึ้นมา
- บันทึกว่า producer/consumer แต่ละตัวควรจะเขียนหรืออ่าน data ได้เท่าไหร่
- เก็บ Authorization ว่า user ไหนถูกอนุญาตให้สร้าง topic บ้าง 
- บันทึกว่าแต่ละ consumer group มี consumer กี่ตัว อ่านไปถึง offset ไหนแล้ว
- มีพรรคพวก(quorum) ของมันเอง นิยมให้เป็นจำนวนเลขคี่เช่น มี 3,5,7


## Apache Kafka

Apache Kafka คือ distributed message queue อาจจะงงนะครับ คิดซะว่าเราเป็นพ่อครัวแม่ครัว ยืนผัดข้าวผัดอยู่ ละมีลูกค้าหิวโซมาสัก 20 คนมาสั่งข้าวผัดหมู ข้าวผัดแหนม เอาไข่เจียว ไข่ดาวสุกบ้างไม่สุกบ้าง ถ้าเป็นแม่ครัวอย่างมากก็ตวาดไป ผัดอยู่ รอก่อนเว้ย มีกระทะเดียว อาจจะทำให้สถานการณ์ดีขึ้นบ้าง แต่ในโลกของการรับส่งข้อมูลมันไม่ได้ควบคุมง่ายขนาดนั้น ถ้าเราเป็นลูกค้าอยู่ร้านข้าวผัดเราก็คงหนีไปกินร้านอื่น แต่ถ้าเป็นโลกของการรับส่งข้อมูล คุมไม่ดี ข้อมูลหาย/ขาด/เกิน หรือถ้าเกี่ยวข้องกับตัวเลขการเงิน ยิ่งร้ายแรง

## Apache Kafka Connect

-	Kafka Connect ทำหน้าที่แปลงข้อมูลจาก Source systems ไปยัง Target systems โดยที่เราไม่ต้องสร้าง producer และ consumer ขึ้นมาเอง

## Apache Kafka Streams

-	Kafka Streams ทำหน้าที่ประมวลผล เปลี่ยนแปลงข้อมูลใน Kafka



## Prometheus

Prometheus คือระบบมอนิเตอร์ริ่งและเตือนภัยแบบโอเพ่นซอร์สที่ถูกออกแบบมาเพื่อรวบรวมและจัดเก็บเมตริกข้อมูลจากระบบและแอปพลิเคชันต่าง ๆ ในรูปแบบของ time series data โดยถูกพัฒนาโดย SoundCloud ในปี 2012 และต่อมาได้กลายเป็นโครงการในองค์กร Cloud Native Computing Foundation (CNCF)



## MongoDB

MongoDB เป็นฐานข้อมูลโอเพ่นซอร์ส No SQL ที่ได้รับความนิยมซึ่งใช้ในการจัดเก็บและดึงข้อมูลด้วยวิธีที่ยืดหยุ่นและปรับขนาดได้ เป็นที่รู้จักในด้านความสามารถในการจัดการข้อมูลปริมาณมาก และความสามารถในการทำงานกับแอปพลิเคชันและภาษาโปรแกรมที่หลากหลาย ฐานข้อมูล MongoDB ได้รับการออกแบบมาให้ใช้งานง่ายและเป็นตัวเลือกที่ยอดเยี่ยมสำหรับนักพัฒนาที่ต้องการสร้างแอปพลิเคชันที่ทันสมัยและขับเคลื่อนด้วยข้อมูล ในบทความนี้ เราจะมาดูกันให้ละเอียดยิ่งขึ้นว่า MongoDB คืออะไร ทำงานอย่างไร รวมถึงฟีเจอร์หลักและคุณประโยชน์ที่ทำให้ MongoDB เป็นตัวเลือกยอดนิยมในหมู่นักพัฒนา




## Grafana

Grafana คือ dashboard tools ตัวนึง ซึ่งจะแสดงผลออกมาเป็นพวก กราฟข้อมูล metrix ต่าง ๆ โดยความเทพของมันคือมันจะดึงข้อมูลออกมาได้ในระดับ realtime โดยมันสามารถดึงข้อมูลมาจาก datasource ที่เป็นที่นิยมได้อย่างมาก เช่น influxdb, Prometheus, elasticsearch, AWS CloudWatch และ datasource ตัวอื่นที่เป็นที่นิยม
จุดเด่นของ Grafana
-	การทำ Metrics สำหรับ Mornitor ดู CPU, Memory หรือ อื่น ๆ ได้ถึงระดับ realtime แล้วนำมาแสดงเป็น Graph Time Series
-	Notification สามารถแจ้งเตือนได้หลายช่องทางมาก เช่น Email, Line, Slack เป็นต้น
-	ความยืดยุ่นในการจัดการกับ Graph หรือ Paanel ต่าง ๆ มี Option ให้จัดการและตกแต่งเยอะมาก
-	ใช้งานได้หลาย Data source




## Iot Sensor
จะเป็นโมดูลเซ็นเซอร์หรือฟังก์ชันที่เกี่ยวกับการรวบรวมข้อมูลจากเซ็นเซอร์ต่างๆบนอุปกรณ์ hardware รวมถึงการอ่านค่าในระบบ IoT ตัวอย่างเช่น:

- อุณหภูมิ: การรวบรวมอุณหภูมิจากเซ็นเซอร์อุณหภูมิ เช่น DHT11, BMP280
- ความชื้น: การเก็บค่าความชื้นในอากาศ
- แสง: การเก็บข้อมูลความเข้มของแสงจาก LDR ที่ทำการต่อเพิ่ม(cucumberไม่มีbuilt-in)
- ความกดอากาศ: atm

การรวบรวมข้อมูลเหล่านี้จะเกิดขึ้นที่ฝั่งอุปกรณ์ฮาร์ดแวร์ เช่น ESP32 หรือ Arduino ที่ต่อกับเซ็นเซอร์ต่างๆ และ การเก็บจะอยู่ส่วนอื่น

## Iot Processor
เป็นการประมวลผลข้อมูลที่ได้จากเซ็นเซอร์ ข้อมูลที่เก็บมาอาจจะถูกส่งไปยังระบบประมวลผลหรือเซิร์ฟเวอร์กลาง การประมวลผลอาจรวมถึง:

- การคำนวณ: เช่นการคำนวณค่าเฉลี่ย หรือค่าความผันแปรของข้อมูล
- การแปลงข้อมูล: เช่น การแปลงหน่วยข้อมูลที่ได้จากเซ็นเซอร์
- การจัดส่งข้อมูล: ส่งข้อมูลไปยัง MQTT broker เพื่อนำไปแสดงผลบน Grafana หรือเก็บในฐานข้อมูล


